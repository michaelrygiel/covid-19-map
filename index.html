<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>D3: Zoom in to reveal counties</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>United States COVID-19 Outbreak Visualization</h1>
    <h6>Updated values as of March 26th, 2019</h6>
    <div class="us-map-visualization"></div>
    <div class="toggle-data">
        <div>
            <label>Actual Numbers or Percentage Based on Population</label>
            <form>
                <input type="radio" id="actual" name="actual-or-percentage" onclick="changeActualOrPercentageData(this);" value="actual" checked>
                <label for="actual">Actual</label><br>
                <input type="radio" id="percentage" name="actual-or-percentage" onclick="changeActualOrPercentageData(this);" value="percentage">
                <label for="percentage">Percentage</label><br>
            </form>
        </div>
    </div>
    <br>
    <div class="hoverData">
        <div>
            <label class="name">In View:</label>
            <label id="name"></label>
        </div>
        <div>
            <label class="confirmed">Confirmed:</label>
            <label id="confirmed"></label>
        </div>
        <div>
            <label class="deaths">Deaths:</label>
            <label id="deaths"></label>
        </div>
        <div>
            <label class="recovered">Recovered:</label>
            <label id="recovered"></label>
        </div>
    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
        
        // Variables for global use
        var currentState = 0;
        var states = [];
        var counties = [];
        var coronavirusCountyData = [];
        var coronavirusStateData = [];
        var usPopulationData = [];
        var countyColorScales = {};
        var stateView = true;
        var showActualData = true;

        var margin = {
            top: 10,
            bottom: 10,
            left: 10,
            right:10
        }, width = parseInt(d3.select('.us-map-visualization').style('width'))
            , width = width - margin.left - margin.right
            , mapRatio = 0.5
            , height = width * mapRatio
            , active = d3.select(null);

        var svg = d3.select('.us-map-visualization').append('svg')
            .attr('class', 'center-container')
            .attr('height', height + margin.top + margin.bottom)
            .attr('width', width + margin.left + margin.right);

        svg.append('rect')
            .attr('class', 'background center-container')
            .attr('height', height + margin.top + margin.bottom)
            .attr('width', width + margin.left + margin.right)
            .on('click', clicked);

        const usMapDataPromise = Promise.resolve(d3.json('us-counties.topojson'));
        const usPopulationDataPromise = Promise.resolve(d3.csv('co-est2019-alldata.csv'));
        const coronavirusCountyDataPromise = Promise.resolve(d3.csv('coronavirusCountyData.csv'));
        const coronavirusStateDataPromise = Promise.resolve(d3.csv('coronavirusStateData.csv'));
        const statesDataPromise = Promise.resolve(d3.csv('states.csv'));
        const countiesDataPromise = Promise.resolve(d3.csv('counties.csv'));
        Promise.all([
            usMapDataPromise,
            usPopulationDataPromise,
            coronavirusCountyDataPromise,
            coronavirusStateDataPromise,
            statesDataPromise,
            countiesDataPromise])
            .then(ready);

        var projection = d3.geoAlbersUsa()
            .translate([width /2 , height / 2])
            .scale(width);

        var path = d3.geoPath()
            .projection(projection);

        var g = svg.append("g")
            .attr('class', 'center-container center-items us-state')
            .attr('transform', 'translate('+margin.left+','+margin.top+')')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)

        function ready(data) {
            let usData = data[0];
            usPopulationData = data[1];
            coronavirusCountyData = data[2];
            coronavirusStateData = data[3];
            states = data[4];
            counties = data[5];

            countyColorScales = generateCountyColorScales();

            g.append("g")
                .attr("id", "counties")
                .selectAll("path")
                .data(topojson.feature(usData, usData.objects.counties).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "county-boundary")
                .attr("id", d => { return d.id; })
                .style('fill', function(d) {
                        return updateCountyColor(d.id);
                      })
                .on("click", reset)
                .on('mouseenter', hoverCounties)
                .on('mouseleave', hoverShowState);

            g.append("g")
                .attr("id", "states")
                .selectAll("path")
                .data(topojson.feature(usData, usData.objects.states).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "state")
                .attr("id", d => { return d.id; })
                .style('fill', function(d) {
                        return updateStateColor(d.id);
                      })
                .on("click", clicked)
                .on('mouseenter', hoverStates)
                .on('mouseleave', hoverShowUS);


            g.append("path")
                .datum(topojson.mesh(usData, usData.objects.states, function(a, b) { return a !== b; }))
                .attr("id", "state-borders")
                .attr("d", path);
            hoverShowUS();
        }

        function clicked(d) {
            stateView = true;

            // If the background is clicked, return to full size
            if (d3.select('.background').node() === this) return reset();

            // If clicked on the active state, return to full size
            if (active.node() === this) return reset();

            // Else, zoom in to state
            stateView = false;
            currentState = d.id;
            active.classed("active", false);
            active = d3.select(this).classed("active", true);

            var bounds = path.bounds(d),
                dx = bounds[1][0] - bounds[0][0],
                dy = bounds[1][1] - bounds[0][1],
                x = (bounds[0][0] + bounds[1][0]) / 2,
                y = (bounds[0][1] + bounds[1][1]) / 2,
                scale = .9 / Math.max(dx / width, dy / height),
                translate = [width / 2 - scale * x, height / 2 - scale * y];

            g.transition()
                .duration(500)
                .style("stroke-width", 1.5 / scale + "px")
                .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
        }


        function reset() {
            active.classed("active", false);
            active = d3.select(null);

            stateView = true;
            currentState = 0;

            g.transition()
                .delay(100)
                .duration(500)
                .style("stroke-width", "1.5px")
                .attr('transform', 'translate('+margin.left+','+margin.top+')');

        }

        function changeActualOrPercentageData(radio) {
            if ((showActualData && radio.value === "percentage") || (!showActualData && radio.value === "actual")) {
                showActualData = radio.value !== "percentage";
                changeColors();
                console.log('New value: ' + radio.value + " " + showActualData);
            }
        }

        function changeColors() {
            // Find all child elements of states and counties <g> html tags
            // For each the elements, change fill attributes on style using respective updateColor functions
            // Make the updateColor functions take another variable, showActualData boolean, to determine if to use actual or percentage data
            return undefined;
        }

        function updateStateColor(stateID) {
            let maxStateConfirmedCases = d3.max(coronavirusStateData, state => {return +state.confirmed});
            let stateColorScale = d3.scaleSqrt().domain([0, maxStateConfirmedCases]).range(['beige', 'red']);
            return stateColorScale(findConfirmedCasesInState(stateID));
        }

        function hoverShowUS() {
            let confirmed = 0, deaths = 0, recovered = 0;
            coronavirusStateData.forEach(state => {
                confirmed += parseInt(state.confirmed);
                deaths += parseInt(state.deaths);
                recovered += parseInt(state.recovered);
            });
            changeHoverData("United States", confirmed, deaths, recovered);
        }

        function hoverShowState() {
            changeStateData(currentState);
        }

        function hoverStates(state) {
            if (stateView) {
                changeStateData(state.id);
            } else {
                changeStateData(currentState);
            }
            console.log("hovering over a state: " + findStateName(state.id));
        }

        function changeStateData(stateID){
            state = coronavirusStateData.find(x => parseInt(x.stateID) === stateID);
            if (state) {
                changeHoverData(state.stateName, state.confirmed, state.deaths, state.recovered);
            }
        }

        function findConfirmedCasesInState(stateID) {
            if (stateID === 72) {
                return 0;
            }
            return coronavirusStateData.find(x => parseInt(x.stateID) === stateID).confirmed;
        }

        function findStateName(stateID) {
            return states.find(x => parseInt(x.stateID) === stateID).stateName;
        }

        function updateCountyColor(countyID) {
            countyColorScale = countyColorScales[convertFullID(countyID)[0]];
            if (countyColorScale) {
                return countyColorScale(findConfirmedCasesInCounty(countyID));
            }
        }

        function hoverCounties(county) {
            if (!stateView) {
                changeCountyData(county.id);
                console.log("hovering over a county: " + findCountyName(county.id));
            }
        }

        function changeCountyData(fullID) {
            county = coronavirusCountyData.find(x => parseInt(x.fips) === fullID);
            if (county) {
                changeHoverData(county.countyName, county.confirmed, county.deaths, county.recovered);
            }
        }

        function generateCountyColorScales() {
            // Split up data by state and put all counties in each state object
            countiesInState = {};
            coronavirusCountyData.forEach(coronavirusCounty => {
                stateID = convertFullID(coronavirusCounty.fips)[0];
                if (countiesInState.hasOwnProperty(stateID)) {
                    countiesInState[stateID].push(coronavirusCounty);
                }
                else {
                    countiesInState[stateID] = [coronavirusCounty];
                }
            });

            // Run through states and generate color scale for counties
            countyColorScales = {};
            for (key in countiesInState) {
                let maxCountyConfirmedCases = d3.max(countiesInState[key], d => {return +d.confirmed});
                countyColorScales[key] = d3.scaleSqrt().domain([0, maxCountyConfirmedCases]).range(['beige', 'red']);
            }
            return countyColorScales;
        }

        function findConfirmedCasesInCounty(fullID) {
            if (fullID.toString().substring(0, 2) === '72') {
                return 0;
            }
            confirmedCases = coronavirusCountyData.find(x => parseInt(x.fips) === fullID);
            return confirmedCases ? confirmedCases.confirmed : 0;
        }

        function changeHoverData(name, confirmed, deaths, recovered) {
            $('#name').text(name);
            $('#confirmed').text(confirmed);
            $('#deaths').text(deaths);
            $('#recovered').text(recovered);
        }

        function findCountyName(fullID){
            ids = convertFullID(fullID);
            let stateID = ids[0];
            let countyID = ids[1];
            return counties.find(x => parseInt(x.stateID) === stateID && parseInt(x.countyID) === countyID).countyName;
        }

        function convertFullID(fullID) {
            id = fullID.toString();
            let stateID = -1;
            let countyID = -1;

            if (id.length === 5) {
                stateID = parseInt(id.substring(0, 2));
                countyID = parseInt(id.substring(2, 5));
            }
            else {
                stateID = parseInt(id.substring(0, 1));
                countyID = parseInt(id.substring(1, 4));
            }
            return [stateID, countyID];
        }
    </script>
</body>
</html>
